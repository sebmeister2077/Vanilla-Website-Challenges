<!DOCTYPE html>
<html lang="en">
    <head style="display: block">
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet" />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"
            integrity="sha512-MgYeYFj8R3S6rvZHiJ1xA9cM/VDGcT4eRRFQwGA7qDP7NHbnWKNmAm28z0LVjOuUqjD0T9JxpDMdVqsZOSHaSA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            defer
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script
            src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"
            integrity="sha512-lbwH47l/tPXJYG9AcFNoJaTMhGvYWhVM9YI43CT+uteTRRaiLCui8snIgyAN8XWgNjNhCqlAUdzZptso6OCoFQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css"
            integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <title>Loading image</title>
        <script>
            tailwind.config = {
                theme: {
                    fontFamily: {
                        sans: ['"Roboto"', 'sans-serif'],
                    },
                },
            }
        </script>
    </head>

    <body class="bg-slate-950 text-stone-300 flex w-screen h-screen p-8">
        <section class="w-1/2 flex items-center justify-center">
            <noscript>This app requires javascript to run</noscript>
            <form>
                <label
                    tabindex="0"
                    for="file-input"
                    class="flex outline-current focus:bg-slate-600 hover:bg-slate-600 focus:outline-offset-[-12px] hover:outline-offset-[-12px] duration-300 items-center rounded-xl bg-slate-500 justify-center p-8 cursor-pointer w-28 h-28 outline-dashed outline-1 outline-offset-[-6px]"
                >
                    <svg class="fill-stone-300" viewBox="0 0 24 24">
                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"></path>
                    </svg>
                </label>
                <input id="file-input" type="file" accept="image/*" hidden />
            </form>
        </section>
        <section class="w-1/2 flex items-center justify-center">
            <div
                id="img-container"
                class="bg-no-repeat bg-cover bg-center rounded-xl overflow-hidden w-[400px] h-[400px]"
            >
                <img src="https://placehold.co/400x400" class="w-full h-full object-cover object-center" />
            </div>
            <script>
                //placeholder image colors
                const image = $('img')
                const newSrc = `${image.attr('src')}/${tailwind.colors.slate['500']}/${
                    tailwind.colors.stone[300]
                }?font=roboto`.replaceAll('#', '')
                image.attr('src', newSrc)
            </script>
        </section>
        <script>
            const { v4: uuidv4 } = uuid
            const { createClient } = supabase
            const supabaseUrl = 'https://lvvyesdqlcwpoeismoxf.supabase.co'
            //public anon key
            const supabaseKey =
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dnllc2RxbGN3cG9laXNtb3hmIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTAxMTQ2MjUsImV4cCI6MjAwNTY5MDYyNX0.7CdAUR4Q5PpzVFbTVuGWmv9KQMULbTgJhHxXsv03A08'
            const _supabase = createClient(supabaseUrl, supabaseKey)
            const bucket = _supabase.storage.from('images')

            const input = $('#file-input')
            $("[for='file-input']").on('keydown', function (e) {
                if (e.key === 'Enter') input.click()
            })

            input.on('change', handleFileUpload)
            var controller = null
            var thumbPath, filePath
            async function handleFileUpload(e) {
                if (controller) controller.abort()
                controller = new AbortController()
                const file = e.target.files?.[0]
                if (!file) return
                //50 MB
                const MAX_FILE_SIZE = 1024 * 1024 * 50
                if (file.size >= MAX_FILE_SIZE) {
                    toastr.error('File is exceeds limit of 50 MB')
                    return
                }

                const fileExtension = file.type.split('/').at(-1)
                filePath = `${uuidv4()}.${fileExtension}`
                thumbPath = `${uuidv4()}_thumb.${fileExtension}`
                const localFilePath = filePath,
                    localThumnPath = thumbPath

                // console.log(data, error)
                const compressedFiles = await Promise.all([
                    compress(file, { maxHeight: 400, maxWidth: 400, quality: 1 }),
                    compress(file),
                ])
                if (compressedFiles[0])
                    uploadToSupabase(localFilePath, compressedFiles[0].data).then(({ data: { path }, err }) => {
                        const url = getUrl(path)
                        $('img').removeAttr('src')
                        setTimeout(() => {
                            $('img').attr('src', url)
                        }, 1000)
                    })
                if (compressedFiles[1])
                    uploadToSupabase(localThumnPath, compressedFiles[1].data).then(({ data: { path }, err }) => {
                        const url = getUrl(path)
                        $('#img-container').addClass(`bg-[url('${url}')]`)
                    })

                if (controller.signal.aborted) {
                    bucket.remove([localFilePath, localThumnPath])
                    return
                }
                controller = null
                // $('img').attr('src', url)
            }

            $(window).on('beforeunload', function (e) {
                toastr.warning('Removing images from storage.')
                if (filePath || thumbPath) {
                    bucket.remove([filePath, thumbPath])
                    for (let index = 0; index < 999999; index++) {}
                }
            })
            function uploadToSupabase(path, file) {
                console.log(file)
                return bucket.upload(path, file, {
                    upsert: true,
                })
            }
            async function compress(
                file,
                { maxWidth, maxHeight, quality } = { maxHeight: 30, maxWidth: 30, quality: 0 },
            ) {
                var scope = {}
                const promise = new Promise(function (res, rej) {
                    scope.res = res
                    scope.rej = rej
                })
                new Compressor(file, {
                    quality,
                    maxWidth,
                    maxHeight,
                    success: (result) => scope.res({ error: null, data: result }),
                    error: (error) => scope.rej({ error, data: null }),
                })
                return promise
            }
            function getUrl(path) {
                const { data } = bucket.getPublicUrl(path)
                return data.publicUrl
            }
        </script>
    </body>
</html>
