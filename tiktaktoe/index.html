<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://cdn.tailwindcss.com" />

        <script
            src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
            crossorigin="anonymous"
        ></script>

        <script src="https://cdn.tailwindcss.com"></script>

        <title>Tic Tac Toe</title>

        <script>
            tailwind.config = {
                theme: {
                    extend: {},
                },
            };
        </script>
    </head>
    <body class="bg-gray-800 text-slate-100 flex w-screen h-screen items-center flex-col pt-12 gap-72">
        <h1 class="text-3xl">Tik Tak Toe?</h1>
        <main class="grid grid-rows-3 grid-cols-3 gap-[4px] relative">
            <button data-cell-button="1-1" class="relative w-16 h-16"></button>
            <button data-cell-button="1-2" class="relative w-16 h-16"></button>
            <button data-cell-button="1-3" class="relative w-16 h-16"></button>
            <button data-cell-button="2-1" class="relative w-16 h-16"></button>
            <button data-cell-button="2-2" class="relative w-16 h-16"></button>
            <button data-cell-button="2-3" class="relative w-16 h-16"></button>
            <button data-cell-button="3-1" class="relative w-16 h-16"></button>
            <button data-cell-button="3-2" class="relative w-16 h-16"></button>
            <button data-cell-button="3-3" class="relative w-16 h-16"></button>
            <span class="absolute w-[4px] top-0 h-full left-1/3 bg-slate-100/[.75] rounded"></span>
            <span class="absolute w-[4px] top-0 h-full left-2/3 bg-slate-100/[.75] rounded"></span>
            <span class="absolute h-[4px] left-0 w-full top-1/3 bg-slate-100/[.75] rounded"></span>
            <span class="absolute h-[4px] left-0 w-full top-2/3 bg-slate-100/[.75] rounded"></span>
        </main>
        <script>
            const MAX_HISTORY_LENGTH = 6;
            let historyQueue = [];

            let currentPlayer = 'X';
            const nextPlayerMap = {
                X: 'O',
                O: 'X',
            };

            document.querySelectorAll('[data-cell-button]').forEach((cellButton) => {
                if (!(cellButton instanceof HTMLButtonElement)) return;
                cellButton.addEventListener('click', function () {
                    const xyData = cellButton.getAttribute('data-cell-button');
                    const x = xyData.split('-')[0],
                        y = xyData.split('-')[1];

                    const shouldIgnoreClick = historyQueue.some((h) => h.x === x && h.y === y);
                    if (shouldIgnoreClick) return;

                    const newElementData = { x, y, id: crypto.randomUUID() };

                    const sizePercentage = 90;
                    const rotationDegrees = 45;
                    const borderWidths = (sizePercentage / 100) * 12;
                    const oElementStr = /*html*/ `<div id="${newElementData.id}" class="shadow-md border-rose-400 [height:calc(${sizePercentage}%_*_cos(${rotationDegrees}deg))] [width:calc(${sizePercentage}%_*_sin(${rotationDegrees}deg))]  border-[${borderWidths}px] rounded-full absolute left-1/2 top-1/2 -translate-y-1/2 -translate-x-1/2"></div>`;
                    const commonStyles = [
                        'absolute',
                        'shadow-md',
                        `content-['']`,
                        'bg-sky-400',
                        `w-[${borderWidths}px]`,
                        `h-[${sizePercentage}%]`,
                        'rounded-lg',
                        'top-1/2',
                        'left-1/2',
                        '-translate-y-1/2',
                        '-translate-x-1/2',
                    ];
                    const xElementStr = /*html*/ `<div id="${
                        newElementData.id
                    }" class="before:rotate-${rotationDegrees} after:-rotate-${rotationDegrees}  ${['before', 'after']
                        .flatMap((ps) => commonStyles.map((s) => `${ps}:${s}`).join(' '))
                        .join(' ')}"></div>`;
                    const elementToAdd = new DOMParser().parseFromString(currentPlayer === 'X' ? xElementStr : oElementStr, 'text/html')
                        .body.firstElementChild;
                    if (!(elementToAdd instanceof HTMLElement)) return;

                    const isQueueAlreadyFull = historyQueue.length === MAX_HISTORY_LENGTH;
                    if (isQueueAlreadyFull) {
                        const lastElement = document.getElementById(historyQueue[0].id);
                        lastElement.remove();
                        historyQueue = historyQueue.slice(1);
                    }
                    historyQueue.push(newElementData);
                    cellButton.appendChild(elementToAdd);
                    currentPlayer = nextPlayerMap[currentPlayer];

                    const needToShowAnimation = historyQueue.length === MAX_HISTORY_LENGTH;
                    if (needToShowAnimation) {
                        const lastElement = document.getElementById(historyQueue[0].id);
                        lastElement.classList.add('animate-pulse');
                    }
                });
            });
        </script>
    </body>
</html>
