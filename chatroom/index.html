<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet" />
        <script
            src="https://code.jquery.com/jquery-3.6.4.slim.js"
            integrity="sha256-dWvV84T6BhzO4vG6gWhsWVKVoa4lVmLnpBOZh/CAHU4="
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.tailwindcss.com"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js" referrerpolicy="no-referrer"></script>

        <title>Chat Room</title>
        <style>
            * {
                font-family: 'Roboto', sans-serif;
            }
            body {
                font-family: Roboto Slab;
            }

            .bubble {
                position: fixed;
                top: 0px;
                left: 0px;
                will-change: translate, opacity, transform;
                transition: translate 0.6s cubic-bezier(0, 0, 0, 1.1), transform 0.5s;
                translate: -100px -100px;
                opacity: 0;
                stroke-dashoffset: 210;
                stroke-dasharray: 210;
                animation: draw 2s 1s 1 forwards;
            }
            .show-cursor {
                stroke-dashoffset: 0;
            }
            @keyframes draw {
                from {
                    stroke-dashoffset: 210;
                }
                to {
                    stroke-dashoffset: 0;
                }
            }
            .cube {
                transform: scale(0);
                transform-style: preserve-3d;
                --transform-amount: calc(0.5 * var(--cube-vertice));
                width: var(--cube-vertice);
                position: relative;
                transition: transform 1.4s cubic-bezier(0, 0, 0, 1);
                will-change: transform;
            }
            .cube-glass {
                position: absolute;
                inset: 0px;
                z-index: 3;
            }
            .cube-face {
                box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
                user-select: none;
                display: grid;
                place-items: center;
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                border: 1px solid #ccc;
                background-color: hsla(0, 0%, 100%, 0.8);
                aspect-ratio: 1;
                opacity: 0.56;
                transition: background-color 0.8s ease-in-out;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        </style>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        backgroundImage: {
                            chat: 'linear-gradient(320deg, rgba(15,173,142,0.36) 0%, rgba(26,283,131,0.5) 100%)',
                        },
                    },
                },
            }
        </script>
    </head>

    <body class="overflow-hidden cursor-none flex w-full h-screen select-none">
        <img
            src="https://wallpaperaccess.com/full/3787594.jpg"
            class="z-[-1] fixed inset-0 h-screen w-screen"
            alt="Generic background with a lighsource in the center"
        />
        <template id="cursor">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="bubble"
                width="24px"
                height="24px"
                viewBox="0 0 24 24"
                fill="none"
                aria-label="Custom cursor"
                aria-live="off"
            >
                <g clip-path="url(#clip0_429_11096)">
                    <path
                        d="M11 20.9999L4 3.99994L21 10.9999L14.7353 13.6848C14.2633 13.8871 13.8872 14.2632 13.6849 14.7353L11 20.9999Z"
                        stroke="#292929"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                </g>
                <defs>
                    <clipPath id="clip0_429_11096">
                        <rect width="24" height="24" fill="white" />
                    </clipPath>
                </defs>
            </svg>
        </template>
        <main class="flex items-stretch h-full grow w-full">
            <script>
                async function getRandomImageUrl() {
                    const fakerImg = faker.image.abstract(40, 40).replace('http://', 'https://').replace('lorempixel', 'loremflickr')
                    const { url } = await fetch(fakerImg, { mode: 'cors' })
                    return url
                }
            </script>
            <aside
                aria-label="Chat"
                id="chat"
                class="group/chat bg-chat z-30 shadow-2xl backdrop-blur-sm gap-4 flex flex-col p-3 h-full cursor-auto w-20 data-[open=true]:w-96 md:w-96 overflow-hidden transition-[width] duration-1000"
            >
                <header class="w-full p-2 border-b border-slate-50/[.50] flex-row-reverse gap-8 flex justify-between">
                    <div class="info w-max whitespace-nowrap order-2 text-neutral-800" aria-live="polite">Online friends:...</div>
                    <button
                        aria-label="Chat Menu"
                        aria-description="Open the Chat on smaller screens"
                        class="md:opacity-0 order-1 transition-opacity duration-500"
                        onclick="const chat = $('#chat');if(chat[0].hasAttribute('data-open')) chat.removeAttr('data-open').attr('aria-hidden','true'); else chat.attr('data-open','true').attr('aria-hidden','false');"
                    >
                        <svg class="fill-slate-50/[80] w-8 h-8" viewBox="0 0 24 24">
                            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
                        </svg>
                    </button>
                </header>

                <section class="flex flex-col grow gap-2 overflow-hidden">
                    <header class="w-full p-1">
                        <h2 class="text-3xl w-full whitespace-nowrap min-w-[300px] text-neutral-800">Chat Messages</h2>
                    </header>
                    <article
                        aria-label="Chat messages"
                        id="messages"
                        class="flex flex-col grow gap-6 overflow-auto px-2 scroll-smooth scrollbar-hide"
                    >
                        <template id="message-template">
                            <div data-uid class="flex w-full gap-1 relative">
                                <img data-image class="rounded-full w-10 h-10 sticky top-0 shadow-sm" alt="User image" />
                                <div
                                    data-messages
                                    class="flex flex-col grow gap-2 pr-2 text-neutral-800 items-start opacity-0 group-data-[open=true]/chat:[opacity:1_!important] md:[opacity:1_!important] transition-opacity duration-500"
                                >
                                    <span data-username class="text-sm w-fit"></span>
                                    <div data-message class="rounded-xl bg-neutral-50/[.85] relative px-4 py-2 shadow-md"></div>
                                </div>
                            </div>
                        </template>
                    </article>
                    <footer class="w-full">
                        <form
                            id="message-form"
                            class="w-full flex justify-between items-center px-2 py-2 relative opacity-0 group-data-[open=true]/chat:[opacity:1_!important] md:[opacity:1_!important] transition-opacity duration-500"
                        >
                            <input
                                placeholder="Type to chat..."
                                name="message"
                                type="text"
                                class="peer/message-input bg-neutral-50/[.85] text-neutral-800 shadow-md outline-0 w-full px-6 py-3 rounded-xl"
                            />
                            <button
                                aria-label="Send message"
                                type="submit"
                                class="peer-placeholder-shown/message-input:scale-0 absolute right-5 text-amber-400 hover:scale-110 focus:scale-110 transition-transform duration-300 outline-0"
                            >
                                <svg class="fill-current w-6 h-6" viewBox="0 0 24 24">
                                    <path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"></path>
                                </svg>
                            </button>
                        </form>
                    </footer>
                </section>
            </aside>
            <section class="flex items-center flex-col justify-center grow">
                <section
                    cube-container
                    class="flex items-center justify-center grow w-full [perspective:200px] [perspective-origin:center] [--cube-vertice:150px]"
                >
                    <div class="cube-glass"></div>
                    <div class="cube">
                        <div
                            class="cube-face"
                            style="transform: translate3d(0px, calc(-1 * var(--transform-amount)), var(--transform-amount))"
                        ></div>
                        <div
                            class="cube-face"
                            style="transform: rotateY(90deg) translate3d(0px, calc(-1 * var(--transform-amount)), var(--transform-amount))"
                        ></div>
                        <div
                            class="cube-face"
                            style="transform: rotateY(90deg) rotateX(90deg) translate3d(0px, 0px, calc(2 * var(--transform-amount)))"
                        ></div>
                        <div
                            class="cube-face"
                            style="
                                transform: rotateY(180deg) rotateZ(90deg)
                                    translate3d(calc(-1 * var(--transform-amount)), 0px, var(--transform-amount));
                            "
                        ></div>
                        <div
                            class="cube-face"
                            style="
                                transform: rotateY(-90deg) rotateZ(90deg)
                                    translate3d(calc(-1 * var(--transform-amount)), 0px, var(--transform-amount));
                            "
                        ></div>
                        <div class="cube-face" style="transform: rotateX(-90deg) translateZ(0px)">Top</div>
                    </div>
                </section>
                <footer class="flex w-full justify-end z-10">
                    <a href="https://firebase.google.com" target="_blank">
                        <img src="./assets/firebaseLogo.svg" alt="Built with Firebase logo" />
                    </a>
                </footer>
            </section>
        </main>
        <script type="module" defer>
            import autoAnimate from './scripts/autoAnimate.js'
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js'
            import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js'
            import {
                getAuth,
                signInAnonymously,
                setPersistence,
                indexedDBLocalPersistence,
            } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js'
            import { getPerformance } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-performance.js'
            import {
                getDatabase,
                ref,
                set,
                onValue,
                push,
                child,
                update,
                get,
                serverTimestamp,
                onDisconnect,
                onChildAdded,
                onChildRemoved,
                onChildChanged,
                query,
                orderByValue,
                orderByKey,
                orderByChild,
                limitToLast,
            } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js'

            import {
                initializeAppCheck,
                ReCaptchaV3Provider,
                getToken,
            } from 'https://cdnjs.cloudflare.com/ajax/libs/firebase/10.4.0/firebase-app-check.min.js'

            const firebaseConfig = Object.freeze({
                apiKey: 'AIzaSyBbn4bnhT_c3j2gwaOWUoMI7iSo3qvFYu0',
                projectId: 'chatroom-000',
                appId: '1:55067342796:web:9488295327025826df8f69',
            })
            const appCheckPublicId = '6LdkVlcoAAAAAFgaHecRfj1tr5R58czFim3D77QB'
            const databaseLocation = Object.freeze('https://chatroom-000-default-rtdb.europe-west1.firebasedatabase.app/')
            const IS_DEBUG = window.location.hostname === '127.0.0.1'

            if (IS_DEBUG) self.FIREBASE_APPCHECK_DEBUG_TOKEN = true
            // Initialize Firebase
            const app = initializeApp(firebaseConfig)
            const performance = getPerformance(app)
            const analytics = getAnalytics(app)

            //If you get lots of errors in console you have to paste the new id in the firebase console / app check section
            const appCheck = getAppCheck(appCheckPublicId)
            getToken(appCheck)
            const auth = getAuth(app)
            setPersistence(auth, indexedDBLocalPersistence)
            const db = getDatabase(app, databaseLocation)

            const USER_ID_LOCATION = 'chatroom_user_uid'
            const DATABASE_ROUTES = new (class {
                #BASE_ROUTE = 'env/' + (IS_DEBUG ? 'development' : window.location.hostname.replace(/\./g, '_'))
                Cube = this.#BASE_ROUTE + '/cube'
                AllUsers = this.#BASE_ROUTE + '/users'
                OneUser(uid) {
                    if (!uid) throw Error('Uid is not defined')
                    return this.AllUsers + '/' + uid
                }
                LastOnline(uid) {
                    return this.OneUser(uid) + '/lastActiveAt'
                }
                OnlineStatus(uid) {
                    return this.OneUser(uid) + '/isOnline'
                }
                InfoConnected = '.info/connected'
                Chat = this.#BASE_ROUTE + '/chat'
            })()

            // autoAnimate($('#messages')[0])
            var randomImg = null
            const imgPromise = getRandomImageUrl().then((val) => {
                randomImg = val
                return val
            })
            const messagesListRef = ref(db, DATABASE_ROUTES.Chat)
            var lastActiveAtInterval = null
            $(function () {
                auth.onAuthStateChanged((user) => {
                    if (lastActiveAtInterval) clearInterval(lastActiveAtInterval)
                    if (!user) {
                        if (localStorage.getItem(USER_ID_LOCATION)) return
                        signInAnonymously(auth)
                        return
                    }
                    localStorage.setItem(USER_ID_LOCATION, user.uid)
                    get(child(ref(db), DATABASE_ROUTES.OneUser(user.uid))).then(async (snapshot) => {
                        var val = {}
                        if (snapshot.exists()) {
                            val = snapshot.val()
                        }
                        currentUserData.color = val.color ?? getRandomColor()
                        currentUserData.photoURL = val.photoURL ?? randomImg ?? (await imgPromise)
                        currentUserData.name = val.name ?? user.displayName ?? faker.internet.userName()
                        setUserData({
                            isOnline: true,
                            uid: user.uid,
                            coords: { x: window.innerWidth / 2, y: window.innerHeight / 2 },
                            lastActiveAt: Date.now(),
                        })
                        applyCurrentUserChatStyles($(`#messages > [data-uid=${user.uid}]`))

                        onDisconnect(ref(db, DATABASE_ROUTES.LastOnline(user.uid))).set(serverTimestamp())
                        onDisconnect(ref(db, DATABASE_ROUTES.OnlineStatus(user.uid))).set(false)
                        lastActiveAtInterval = setInterval(() => {
                            currentUserData.lastActiveAt = Date.now()
                            //1hour
                        }, 3600000)
                    })
                })

                const cubeRef = ref(db, DATABASE_ROUTES.Cube)
                onValue(cubeRef, (snapshot) => {
                    const DEFAULT_COLOR = 'hsl(0, 0%, 100%)'
                    if (!snapshot.exists()) {
                        setCubeData({ movingUserId: '', rotation: { x: 0, y: 0 }, color: DEFAULT_COLOR })
                        return
                    }
                    currentCubeData = snapshot.val()

                    if (!currentCubeData.rotation) setCubeData({ ...currentCubeData, rotation: { x: 0, y: 0 } })
                    else rotateCube(currentCubeData.rotation, currentCubeData.color || DEFAULT_COLOR)
                })

                const currentValueKeys = []
                const usersListRef = ref(db, DATABASE_ROUTES.AllUsers)
                onValue(usersListRef, (snapshot) => {
                    if (!snapshot.exists()) return
                    const data = snapshot.val()
                    const NOW = Date.now()
                    const OFFSET = 60_000 // 1 min
                    const { origin } = location

                    const keys = Object.keys(data).filter((k) => data[k].isOnline)

                    currentValueKeys.filter((ck) => !keys.includes(ck)).forEach((key) => $(`[key=${key}]`).remove())

                    const maxConnectionLimit = 100
                    const newText = 'Online friends:' + keys.length + '/' + maxConnectionLimit
                    const info = $('.info')
                    if (info.text() !== newText) info.text(newText)

                    keys.forEach((key) => {
                        if (currentValueKeys.includes(key)) {
                            $(`svg[key=${key}]`).css({
                                translate: `${data[key].coords.x}px ${data[key].coords.y}px`,
                            })
                            return
                        }
                        currentValueKeys.push(key)
                        const newNode = $('#cursor')
                            .html((i, old) => old.trim())
                            .contents()
                            .clone(true, true)
                        newNode.attr('key', key).css({ opacity: 1 })
                        if (key === currentUserData.uid) {
                            newNode
                                .css({
                                    translate: `${data[key].coords.x}px ${data[key].coords.y}px`,
                                    transition: 'translate 0.2s cubic-bezier(0, 0, 0, 1.1), transform .3s',
                                    animation: 'none',
                                })
                                .addClass('show-cursor')
                        }
                        newNode.children('g').children('path').attr('stroke', data[key].color)
                        $(document.body).append(newNode)
                    })
                })

                // //initial messages render
                // onValue(
                //     messagesListRef,
                //     (snapshot) => {
                //         if (!snapshot.exists()) return
                //         const values = snapshot.val()
                //         const messages = Object.keys(values)
                //             .map((k) => values[k])
                //             .sort((a, b) => (a.timestamp > b.timestamp ? 1 : -1))
                //         // .forEach(createDomMessage)
                //     },
                //     { onlyOnce: true },
                // )
                //listen for new messages
                onChildAdded(query(messagesListRef, orderByChild('timestamp'), limitToLast(100)), (data) => {
                    const val = data.val()
                    createDomMessage(val)
                })

                const throttledCursorMove = throttleFunction(function (e) {
                    const { buttons } = e.originalEvent

                    // e.stopPropagation()
                    if (!auth.currentUser) return

                    const cursorSvg = $(`svg[key=${currentUserData.uid}]`)
                    //because aside is now higher z-index
                    // const isInChat = false && isUnderElement('aside', e)
                    // if (isInChat) {
                    //     cursorSvg.css('opacity', 0)
                    //     return
                    // }

                    cursorSvg.css({
                        translate: `${e.clientX}px ${e.clientY}px`,
                    })
                    if (buttons === 1) cursorSvg.addClass('scale-150')
                    else cursorSvg.removeClass('scale-150')

                    const coords = { x: e.clientX, y: e.clientY }
                    if (!coords.x && !coords.y) {
                        const touch = e.touches[0]
                        coords.x = touch.clientX
                        coords.y = touch.clientY
                    }
                    setUserData({
                        coords,
                    })
                }, 70)
                $(document).on({
                    mousemove: throttledCursorMove,
                    touchmove: throttledCursorMove,
                    mousedown: function () {
                        $(`svg[key=${currentUserData.uid}]`).addClass('scale-150')
                    },
                    mouseup: function () {
                        $(`svg[key=${currentUserData.uid}]`).removeClass('scale-150')
                    },
                })

                var startPosition = {}
                $('.cube-glass')
                    .get(0)
                    .addEventListener(
                        'mousedown',
                        function (e) {
                            if (!auth.currentUser || (currentCubeData.movingUserId !== currentUserData.uid && currentCubeData.movingUserId))
                                return
                            e.stopPropagation()
                            startPosition.x = e.clientX
                            startPosition.y = e.clientY
                            setCubeData({
                                movingUserId: currentUserData.uid,
                                color: currentUserData.color,
                            })
                        },
                        true,
                    )
                $('.cube-glass').on('mouseup', function (e) {
                    if (currentCubeData.movingUserId === currentUserData.uid && currentUserData.uid) return
                    setCubeData({ movingUserId: '', color: '' })
                })
                const throttleMove = throttleFunction((e) => {
                    if (e.buttons !== 0 && !currentCubeData.movingUserId && auth.currentUser) {
                        setCubeData({ movingUserId: currentUserData.uid })
                        startPosition.x = e.clientX
                        startPosition.y = e.clientY
                    }
                    if (currentCubeData.movingUserId !== currentUserData.uid || !currentCubeData.movingUserId || !currentUserData.uid)
                        return

                    if (e.buttons === 0) {
                        if (currentCubeData.movingUserId === currentUserData.uid)
                            setCubeData({
                                movingUserId: '',
                                color: '',
                            })
                        return
                    }
                    const SENSITIVITY = 0.05
                    const { clientX, clientY } = e
                    const currentRotation = currentCubeData.rotation
                    const deltaX = startPosition.x - clientX
                    const deltaY = startPosition.y - clientY
                    currentRotation.x = (parseFloat(currentRotation.x) + deltaY * SENSITIVITY).toFixed(2)
                    currentRotation.y = (parseFloat(currentRotation.y) + deltaX * SENSITIVITY).toFixed(2)
                    setCubeData({
                        rotation: currentRotation,
                        color: currentUserData.color,
                    })
                }, 80)
                $('#message-form').on('submit', (e) => {
                    e.stopPropagation()
                    e.preventDefault()
                    const formData = new FormData(e.target)
                    const message = formData.get('message').trim()
                    if (!message) return
                    e.target.reset()
                    pushToChat(message)
                })
                $('.cube-glass').on('mousemove', throttleMove)
            })
            var currentUserData = {}
            var currentCubeData = {}
            function setCubeData(data) {
                Object.assign(currentCubeData, data)
                if (Object.keys(currentCubeData).length === 0 || !db) return
                update(ref(db), { [DATABASE_ROUTES.Cube]: { ...currentCubeData, ...data } })
            }
            function setUserData(data) {
                Object.assign(currentUserData, data)
                if (!currentUserData.uid || !db) return
                update(ref(db), { [DATABASE_ROUTES.OneUser(currentUserData.uid)]: currentUserData })
            }
            function pushToChat(message) {
                if (!currentUserData.uid || !messagesListRef) return
                const newMessageRef = push(messagesListRef)
                const data = {
                    userId: currentUserData.uid,
                    username: currentUserData.name,
                    photoURL: currentUserData.photoURL,
                    message,
                }
                set(newMessageRef, {
                    ...data,
                    timestamp: serverTimestamp(),
                })
                // createDomMessage({
                //     ...data,
                //     timestamp: Date.now(),
                // })
            }
            const cubeWidth = parseInt(getComputedStyle($('main')[0]).getPropertyValue('--cube-vertice').replace('px', ''))
            function rotateCube({ x, y }, color) {
                const translateY = (cubeWidth * 0.5 * Math.cos((Math.PI * x) / 180)).toFixed(1)
                const translateZ = (cubeWidth * 0.5 * Math.sin((Math.PI * x) / 180)).toFixed(1)
                // console.log({ x, y, translateY, translateZ })
                $('.cube').css({
                    transform: `rotateX(${x}deg) rotateY(${y}deg)`, // translateY(${translateY}px) translateZ(${translateZ}px)`,
                })
                $('.cube-face').css({
                    backgroundColor: addAlphaToHsl(color, 0.8),
                })
            }
            function createDomMessage({ message, photoURL, username, timestamp, userId }) {
                const template = $('#message-template')
                const el = template
                    .html((i, old) => old.trim())
                    .contents()
                    .clone(true, true)

                if (userId === currentUserData.uid) {
                    applyCurrentUserChatStyles(el)
                }
                el.attr('data-uid', userId)

                const userNameId = crypto.randomUUID()
                $('[data-image]', el).attr('src', photoURL)
                $('[data-username]', el).text(username).attr('id', userNameId)

                const messageEl = $('[data-message]', el).text(message).attr('aria-labelledby', `${userNameId} said`)
                const NR_CHARACTERS_ON_ONE_ROW = 28
                if (message.length >= NR_CHARACTERS_ON_ONE_ROW) messageEl.addClass(`min-w-[${NR_CHARACTERS_ON_ONE_ROW}ch]`)
                else messageEl.addClass('min-w-max')

                const messageContainer = $('#messages')
                const lastMessage = messageContainer.children('[data-uid]').last()

                const lastUserId = lastMessage.attr('data-uid')

                if (lastUserId === userId) {
                    const textEl = $('[data-message]', el)
                    lastMessage.children('[data-messages]').append(textEl)
                    setTimeout(() => {
                        textEl[0].scrollIntoView()
                    }, 10)
                    return
                }
                setTimeout(() => {
                    el[0]?.scrollIntoView()
                }, 10)
                messageContainer.append(el)
            }
            window.f = getRandomColor
            function getRandomColor() {
                const hue = Math.floor(Math.random() * 361)
                const saturation = 100
                const lightness = Math.floor(Math.random() * 41) + 15
                return `hsl(${hue},${saturation}%,${lightness}%)`
            }
            function addAlphaToHsl(hsl, alpha) {
                return hsl
                    .split('%)')
                    .join(`%, ${Math.max(Math.min(alpha, 1), 0)})`)
                    .replace('hsl', 'hsla')
            }
            function applyCurrentUserChatStyles(jqueryEl) {
                jqueryEl
                    .addClass('flex-row-reverse')
                    .children('[data-messages]')
                    .removeClass('items-start')
                    .addClass('items-end')
                    .children('[data-message]')
                    .addClass('bg-yellow-400/[.85]')
                    .attr('data-currentuser', '')
            }
            function isUnderElement(elem, e) {
                const elemWidth = $(elem).width()
                const elemHeight = $(elem).height()
                const elemPosition = $(elem).offset()
                const elemPosition2 = {}
                elemPosition2.top = elemPosition.top + elemHeight
                elemPosition2.left = elemPosition.left + elemWidth

                return (
                    e.pageX > elemPosition.left && e.pageX < elemPosition2.left && e.pageY > elemPosition.top && e.pageY < elemPosition2.top
                )
            }
            function getAppCheck(token) {
                return initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider(token),
                    isTokenAutoRefreshEnabled: true,
                })
            }
            const throttleFunction = (cb, delay = 250) => {
                let shouldWait = false
                let waitingArgs
                const timeoutFunc = () => {
                    if (waitingArgs == null) {
                        shouldWait = false
                        return
                    }
                    cb(...waitingArgs)
                    waitingArgs = null
                    setTimeout(timeoutFunc, delay)
                }
                return (...args) => {
                    if (shouldWait) {
                        waitingArgs = args
                        return
                    }
                    cb(...args)
                    shouldWait = true
                    setTimeout(timeoutFunc, delay)
                }
            }
        </script>
    </body>
</html>
